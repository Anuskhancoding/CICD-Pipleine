name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: website-files
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}
    
    - name: Extract files
      run: |
        echo "Extracting files..."
        mkdir -p /home/hp/website
        unzip -o website.zip -d /home/hp/website/
        echo "Files extracted to /home/hp/website/!"
        ls -la /home/hp/website/
    
    - name: Stop existing server
      run: |
        echo "Stopping any existing server on port 3000..."
        pkill -f "python3.*http.server.*3000" || echo "No existing server found"
        # Also kill any existing screen sessions
        screen -S webserver -X quit 2>/dev/null || echo "No existing screen session"
        sleep 2
        
    - name: Start web server in screen
      run: |
        echo "Starting web server on port 3000 in screen session..."
        cd /home/hp/website
        # Start server in detached screen session
        screen -dmS webserver python3 -m http.server 3000 --bind 0.0.0.0
        sleep 3
        echo "Server started in detached screen session 'webserver'"
        
    - name: Verify server is accessible
      run: |
        echo "Testing server accessibility..."
        sleep 2
        # Check if screen session exists
        if screen -ls | grep -q webserver; then
          echo "âœ… Screen session 'webserver' is running"
        else
          echo "âŒ Screen session not found"
          exit 1
        fi
        
        # Test if server responds
        if curl -s http://localhost:3000 | grep -q "Hello World"; then
          echo "âœ… Server responds on localhost:3000"
        else
          echo "âŒ Server not responding on localhost"
          exit 1
        fi
        
        if curl -s http://192.168.100.143:3000 | grep -q "Hello World"; then
          echo "âœ… Website is live at http://192.168.100.143:3000"
        else
          echo "âŒ Server not responding externally"
          exit 1
        fi
        
        echo "ğŸš€ Deployment complete! Website running in screen session."
        echo "ğŸ“± Access your website at: http://192.168.100.143:3000"
        echo "ğŸ”§ To check server: screen -r webserver"
        echo "ğŸ”§ To detach from screen: Ctrl+A then D"
